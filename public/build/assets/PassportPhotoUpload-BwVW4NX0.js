import{r as l,j as t,a as X}from"./app-BCbVRjYH.js";import{B as S}from"./button-uRfG0SJk.js";import{L as H}from"./label-B0XYP5fN.js";import{u as Y}from"./use-tenant-router-DiYxGHG9.js";import{U as T}from"./upload-BYoUKMoT.js";import{X as D}from"./x-D611PGoW.js";/* empty css            */import"./utils-DawFQoOT.js";import"./createLucideIcon-GhyqP1ys.js";const _=600,q=.85,A=2;function G(R,g){return new Promise((z,h)=>{const u=new Image,o=URL.createObjectURL(R);u.onload=()=>{URL.revokeObjectURL(o);let i=u.naturalWidth,r=u.naturalHeight,c=.8;const s=()=>{const m=document.createElement("canvas");m.width=i,m.height=r;const e=m.getContext("2d");if(!e)return h(new Error("Canvas not supported"));e.drawImage(u,0,0,i,r),m.toBlob(p=>{if(!p)return h(new Error("Failed to create blob"));if(p.size<=g||i<=100&&c<=.5)return z(p);c>.5?(c-=.15,s()):(i=Math.max(100,Math.round(i*.85)),r=Math.max(100,Math.round(r*.85)),c=.8,s())},"image/jpeg",c)};s()},u.onerror=()=>{URL.revokeObjectURL(o),h(new Error("Failed to load image"))},u.src=o})}function J(R,g,z){return new Promise((h,u)=>{const o=new Image,i=URL.createObjectURL(R);o.onload=()=>{URL.revokeObjectURL(i);const{naturalWidth:r,naturalHeight:c,displayWidth:s,displayHeight:m}=z,e=Math.min(r/s,c/m),p=Math.round(g.size*e),b=Math.round(g.x*e),y=Math.round(g.y*e),E=Math.min(p,r-b,c-y,b>=0&&y>=0?p:0),d=Math.max(1,E),f=Math.max(0,Math.min(b,r-d)),N=Math.max(0,Math.min(y,c-d)),v=Math.min(d,_),j=document.createElement("canvas");j.width=v,j.height=v;const M=j.getContext("2d");if(!M){u(new Error("Canvas not supported"));return}M.drawImage(o,f,N,d,d,0,0,v,v),j.toBlob(U=>{U?h(U):u(new Error("Failed to create blob"))},"image/jpeg",q)},o.onerror=()=>{URL.revokeObjectURL(i),u(new Error("Failed to load image"))},o.src=i})}function re({staffUuid:R,currentPhotoUrl:g}){const z=Y(),h=l.useRef(null),u=l.useRef(null),[o,i]=l.useState(null),[r,c]=l.useState(null),[s,m]=l.useState(null),[e,p]=l.useState({x:0,y:0,size:200}),[b,y]=l.useState(!1),[E,d]=l.useState(null),f=l.useRef(null),N=a=>{var x;const n=(x=a.target.files)==null?void 0:x[0];if(d(null),!n){i(null),m(null),r&&URL.revokeObjectURL(r),c(null);return}if(!n.type.startsWith("image/")){d("Please select an image file (JPEG, PNG, etc.).");return}if(n.size>2*1024*1024){d("Image must be under 2 MB. It will be resized and compressed for upload.");return}i(n),r&&URL.revokeObjectURL(r),c(URL.createObjectURL(n)),m(null),p({x:0,y:0,size:200})},v=l.useCallback(a=>{const n=a.currentTarget,x=n.naturalWidth,C=n.naturalHeight,L=n.getBoundingClientRect(),w=Math.round(L.width),k=Math.round(L.height);m({naturalWidth:x,naturalHeight:C,displayWidth:w,displayHeight:k});const F=Math.min(w,k)*.9,O=(w-F)/2,W=(k-F)/2;p({x:O,y:W,size:F})},[]),j=l.useCallback(a=>{a.preventDefault(),s&&(f.current={startX:a.clientX,startY:a.clientY,startCropX:e.x,startCropY:e.y})},[s,e.x,e.y]),M=l.useCallback(a=>{if(!f.current||!s)return;const n=a.clientX-f.current.startX,x=a.clientY-f.current.startY,C=s.displayWidth-e.size,L=s.displayHeight-e.size;p(w=>({...w,x:Math.max(0,Math.min(C,f.current.startCropX+n)),y:Math.max(0,Math.min(L,f.current.startCropY+x))}))},[s,e.size]),U=l.useCallback(()=>{f.current=null},[]);l.useEffect(()=>(window.addEventListener("mousemove",M),window.addEventListener("mouseup",U),()=>{window.removeEventListener("mousemove",M),window.removeEventListener("mouseup",U)}),[M,U]);const I=()=>{i(null),m(null),r&&(URL.revokeObjectURL(r),c(null)),d(null),h.current&&(h.current.value="")},P=async()=>{if(!(!o||!s)){y(!0),d(null);try{let a=await J(o,e,s);const n=A*1024*1024;a.size>n&&(a=await G(a,n)),await B(a)}catch(a){d(a instanceof Error?a.message:"Failed to process image.")}finally{y(!1)}}},B=a=>{const n=new File([a],"passport.jpg",{type:"image/jpeg"}),x=new FormData;return x.append("passport_photo",n),new Promise((C,L)=>{X.post(z.route("hr.staff.passport.upload",{staff:R}),x,{forceFormData:!0,preserveScroll:!0,onSuccess:()=>{I(),C()},onError:w=>{d(Object.values(w).join(" ")||"Upload failed. Try a smaller image (under 2 MB)."),L(new Error("Upload failed"))},onFinish:()=>{}})})};return t.jsxs("div",{className:"space-y-3",children:[t.jsx(H,{children:"Passport photo"}),g&&!o&&t.jsxs("div",{className:"flex items-start gap-3",children:[t.jsx("img",{src:g,alt:"Current passport",className:"h-24 w-24 rounded-lg border object-cover"}),t.jsx("p",{className:"text-sm text-muted-foreground",children:"Current photo on file. Upload a new image to replace."})]}),r&&o&&t.jsxs("div",{className:"space-y-2",children:[t.jsx("p",{className:"text-sm text-muted-foreground",children:"Drag the square to choose the area to crop. Then click Crop & upload. Image is resized to keep upload under 2 MB."}),t.jsxs("div",{ref:u,className:"relative inline-block max-h-[320px] max-w-full overflow-hidden rounded-lg border bg-muted/30",children:[t.jsx("img",{src:r,alt:"Preview",className:"block max-h-[280px] max-w-full object-contain",onLoad:v}),s&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"pointer-events-none absolute inset-0",children:[t.jsx("div",{className:"absolute left-0 top-0 bg-black/45",style:{width:s.displayWidth,height:e.y}}),t.jsx("div",{className:"absolute bg-black/45",style:{left:0,top:e.y,width:e.x,height:e.size}}),t.jsx("div",{className:"absolute bg-black/45",style:{left:e.x+e.size,top:e.y,width:s.displayWidth-e.x-e.size,height:e.size}}),t.jsx("div",{className:"absolute left-0 bg-black/45",style:{top:e.y+e.size,width:s.displayWidth,height:s.displayHeight-e.y-e.size}})]}),t.jsx("div",{className:"absolute cursor-move rounded-lg border-2 border-primary bg-primary/10",style:{left:e.x,top:e.y,width:e.size,height:e.size},onMouseDown:j})]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(S,{type:"button",size:"sm",onClick:P,disabled:b||!s,children:b?"Uploadingâ€¦":t.jsxs(t.Fragment,{children:[t.jsx(T,{className:"mr-1.5 h-4 w-4"}),"Crop & upload"]})}),t.jsxs(S,{type:"button",size:"sm",variant:"outline",onClick:I,disabled:b,children:[t.jsx(D,{className:"mr-1.5 h-4 w-4"}),"Cancel"]})]})]}),!o&&t.jsxs("div",{className:"space-y-1.5",children:[t.jsx("input",{ref:h,type:"file",accept:"image/*",onChange:N,className:"border-input file:text-foreground flex h-9 max-w-xs rounded-md border bg-transparent px-3 py-1 text-sm file:inline-flex file:border-0 file:bg-transparent file:font-medium"}),t.jsx("p",{className:"text-xs text-muted-foreground",children:"Max 2 MB; will be resized for upload."})]}),E&&t.jsx("p",{className:"text-sm text-destructive",children:E})]})}export{re as PassportPhotoUpload};
